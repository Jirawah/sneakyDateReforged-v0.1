<main class="auth-wrap">
  <section class="auth-panel">
    <h2>Inscription</h2>

    <form [formGroup]="form" (ngSubmit)="submit()" class="auth-form">

      <!-- Email -->
      <mat-form-field appearance="outline">
        <mat-label>Email</mat-label>
        <input matInput type="email" formControlName="email" required />
        <mat-error *ngIf="form.get('email')?.hasError('required')">
          Email requis
        </mat-error>
        <mat-error *ngIf="form.get('email')?.hasError('email')">
          Format invalide
        </mat-error>
      </mat-form-field>

      <!-- Steam ID -->
      <mat-form-field appearance="outline">
        <mat-label>Steam ID</mat-label>
        <input matInput formControlName="steamId" required />
        <mat-error *ngIf="form.get('steamId')?.hasError('required')">
          Steam ID requis
        </mat-error>
      </mat-form-field>

      <!-- Connexion Discord -->
      <div class="discord-connect">

        <!-- Bouton pour lancer le flux Discord -->
        <button
          type="button"
          mat-raised-button
          class="btn-discord"
          (click)="openDiscordInvite()">
          Ouvrir Discord
        </button>

        <!-- Statut Discord -->
        <div class="status" *ngIf="form.get('discordConnected')?.value; else waitingDiscord">
          ✅ Discord connecté
        </div>
        <ng-template #waitingDiscord>
          <div class="status">
            En attente de validation Discord...
          </div>
        </ng-template>

        <!-- Pseudo détecté côté backend -->
        <div class="detected-pseudo" *ngIf="discordPseudoFromBackend">
          Pseudo détecté :
          <strong>{{ discordPseudoFromBackend }}</strong>
          <small>(ce pseudo sera utilisé dans l'application)</small>
        </div>

        <!-- Checkbox (lecture seule dans l'UI, mais liée au formControl) -->
        <mat-checkbox
          formControlName="discordConnected"
          class="discord-checkbox"
          [disabled]="true"
          color="primary">
          Connexion Discord validée
        </mat-checkbox>
      </div>

      <!-- Mot de passe -->
      <mat-form-field appearance="outline">
        <mat-label>Mot de passe (≥12 caractères)</mat-label>
        <input matInput type="password" formControlName="password" required />
        <mat-hint>12 caractères minimum</mat-hint>
        <mat-error *ngIf="form.get('password')?.hasError('required')">
          Requis
        </mat-error>
        <mat-error *ngIf="form.get('password')?.hasError('minlength')">
          Minimum 12 caractères
        </mat-error>
      </mat-form-field>

      <!-- Confirmation mot de passe -->
      <mat-form-field appearance="outline">
        <mat-label>Confirmer le mot de passe</mat-label>
        <input matInput type="password" formControlName="confirmPassword" required />
        <mat-error *ngIf="form.get('confirmPassword')?.hasError('required')">
          Requis
        </mat-error>
        <mat-error *ngIf="form.hasError('passwordsMismatch')">
          Les mots de passe ne correspondent pas
        </mat-error>
      </mat-form-field>

      <!-- Bouton créer mon compte -->
      <button
        mat-flat-button
        color="primary"
        type="submit"
        [disabled]="
          loading
          || form.invalid
          || !form.get('discordConnected')?.value
        ">
        {{ loading ? 'Création…' : 'Créer mon compte' }}
      </button>

      <!-- Erreur globale -->
      <p *ngIf="error" class="auth-error">{{ error }}</p>

      <!-- Lien vers login -->
      <div class="auth-links">
        <a mat-button routerLink="/auth/login">J’ai déjà un compte</a>
      </div>
    </form>
  </section>
</main>
